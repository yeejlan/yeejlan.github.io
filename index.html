<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="Yee's 部落格" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Yee's 部落格</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Yee's 部落格</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2014-07-15T08:09:00.000Z" class="post__time">July 15, 2014</time><h1 class="post__title"><a href="/2014/07/15/log-collection-using-logstash-elasticsearch-and-kibana/">使用logstash, elasticsearch, kibana做日志分析系统</a></h1></header><div class="post__main echo"><p>一般情况下，一个站点会由多台server构成, 每台server每天会产生多种不同的日志，为了方面分析线上日志，常用做法是把线上日志集中存储到一个地方，然后按照日期，日志类型，日志内关键字等条件查询。而logstash, elasticsearch, 和kibana就是用来做这件事的开源解决方案。</p>
<p><a href="http://logstash.net/" target="_blank" rel="external">Logstash</a> 运行于Jruby上的日志收集和分析系统，支持多种后端存储，包括elasticsearch, s3, riak, mongodb, redis等<br><a href="http://www.elasticsearch.org/" target="_blank" rel="external">Elasticsearch</a> Java写的搜索引擎，简单好用，很适合日志的存储和查询, 简称ES<br><a href="http://www.elasticsearch.org/overview/kibana/" target="_blank" rel="external">Kibana</a> Elasticsearch的查询前端，最早用PHP写的，后来用Ruby重新实现了一遍，最新版本是纯Javascript的，直接在浏览器端运行。</p>
<p>架构上，在服务器不多的情况下，可以使用Logstash分析日志后，直接存储到ES里面，然后调用Kibana做日志查询。</p>
<p>如果服务器很多，或者是需要跨网络，那么可以使用前向代理，做成树状结构，树叶是Logstash，分析完成后传给树枝<a href="https://github.com/elasticsearch/logstash-forwarder" target="_blank" rel="external">logstash-forwarder</a>, 然后传给树干Logstash, 最终输出汇总给ES</p>
<p>Logstash, elasticsearch, kibana的安装都很简单，这里直接略过，下面说下logstash是如何完成日志收集工作的。</p>
<p>Logstash日志收集可以分成3大块，input, filter和output, 可以通过启动时指定配置文件来配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>./bin/logstash <span class="operator">-f</span> config_file
</pre></td></tr></table></figure>

<h3 id="Input是配置日志源的，这里使用文件做例子:">Input是配置日志源的，这里使用文件做例子:</h3>
<figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>input {
  file {
    #日志存储格式 /web/mywebsite/logs/<span class="number">201407</span>/login_errr_10.<span class="keyword">log</span>
    path =&gt; <span class="string">"/web/mywebsite/logs/*/*"</span>  
    <span class="keyword">type</span> =&gt; <span class="string">"web_log"</span>
  }

  file {
    #日志存储格式 /web/mywebsite/logs/apache_access.<span class="keyword">log</span>
    path =&gt; <span class="string">"/web/mywebsite/logs/*"</span>
    <span class="keyword">type</span> =&gt; <span class="string">"access_log"</span>
  }
}
</pre></td></tr></table></figure>

<p>可以看到指定输入的时候可以使用通配符监视多个文件。</p>
<h3 id="Filter用来对日志做过滤，比较常用的filter有">Filter用来对日志做过滤，比较常用的filter有</h3>
<p><a href="http://logstash.net/docs/1.4.2/filters/grok" target="_blank" rel="external">grok</a> 通过正则表达式把每一行的日志做匹配，把非结构化的信息变成结构化的<br><a href="http://logstash.net/docs/1.4.2/filters/date" target="_blank" rel="external">date</a> 可以用指定字段的值作为当前log的时间戳，而不是使用导入log时的系统时间。</p>
<p>解释起来比较拗口，看实际的配置例子更容易理解。</p>
<p><figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre>filter {
  <span class="comment">#可以使用条件语句的, 中括号里面的[type]代表引用type这个字段的值</span>
  <span class="keyword">if</span> [type] == <span class="string">"access_log"</span> {
    grok {
      <span class="comment">#COMBINEDAPACHELOG, 预定义的一组正则</span>
      match =&gt; { <span class="string">"message"</span> =&gt; <span class="string">"%{COMBINEDAPACHELOG}"</span> }
    }

    <span class="comment">#这里把[timestamp]这个字段的值按照"dd/MMM/yyyy:HH:mm:ss Z"的格式解析成日期，作为本条log的产生日期。</span>
    date {
      match =&gt; [ <span class="string">"timestamp"</span> , <span class="string">"dd/MMM/yyyy:HH:mm:ss Z"</span> ]
    }
  } <span class="keyword">else</span> {

    <span class="comment">#匹配这样的消息:  2014-07-14T22:10:51-07:00 INFO (6): log body</span>
    grok {
      match =&gt; {<span class="string">"message"</span>  =&gt; <span class="string">"%{TIMESTAMP_ISO8601:timestamp} %{DATA:data}"</span>}
    }

    <span class="comment">#这里把[timestamp]这个字段的值按照iso8601的格式解析</span>
    date {
      match =&gt; [ <span class="string">"timestamp"</span> , <span class="string">"ISO8601"</span> ]
    }
  }
}
</pre></td></tr></table></figure><br>上面的COMBINEDAPACHELOG是一组预定义的正则，<a href="https://github.com/logstash/logstash/tree/v1.4.2/patterns" target="_blank" rel="external">https://github.com/logstash/logstash/tree/v1.4.2/patterns</a>这里能看到更多的。</p>
<p>使用上面配置解析出的log如下</p>
<p><figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>{
	<span class="string">"message"</span> =&gt; <span class="string">"2014-07-14T22:12:26-07:00 INFO (6): Log detail"</span>,
	<span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,
	<span class="string">"@timestamp"</span> =&gt; <span class="string">"2014-07-15T05:12:26.000Z"</span>,
	<span class="string">"type"</span> =&gt; <span class="string">"web_log"</span>,
	<span class="string">"host"</span> =&gt; <span class="string">"myserver.local"</span>,
	<span class="string">"path"</span> =&gt; <span class="string">"/web/mywebsite/logs/201407/login_error_14.txt"</span>,
	<span class="string">"timestamp"</span> =&gt; <span class="string">"2014-07-14T22:12:26-07:00"</span>
}
</pre></td></tr></table></figure></p>
<h2 id="在使用Filter转换好格式后，就可以配置output输出了">在使用Filter转换好格式后，就可以配置output输出了</h2>
<p><figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre>output {
  stdout { codec =&gt; rubydebug }
  elasticsearch_http { host =&gt; localhost port =&gt; <span class="number">9200</span>}
}
</pre></td></tr></table></figure><br>可以看到，我配置了2个输出，一个使用rubydebug的格式打印到console上，一个使用elasticsearch_http输出到ES。</p>
<p>以上就是logstash的配置过程，最重点的部分在filter上。数据到了ES之后，使用kibana查询可以参考这里的<a href="http://www.elasticsearch.org/guide/en/kibana/current/" target="_blank" rel="external">介绍</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/logstash/" class="post__tag__link">logstash</a></li><li class="post__tag__item"><a href="/tags/elasticsearch/" class="post__tag__link">elasticsearch</a></li><li class="post__tag__item"><a href="/tags/kibina/" class="post__tag__link">kibina</a></li></ul><a href="/2014/07/15/log-collection-using-logstash-elasticsearch-and-kibana/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2014-07-10T05:33:30.000Z" class="post__time">July 10, 2014</time><h1 class="post__title"><a href="/2014/07/10/host-blog-on-github-using-hexo/">用hexo在github上搭建个人博客</a></h1></header><div class="post__main echo"><p>幻灯片<a href="/remark/host-blog-on-github-using-hexo.html">看这里</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/hexo/" class="post__tag__link">hexo</a></li><li class="post__tag__item"><a href="/tags/github/" class="post__tag__link">github</a></li></ul><a href="/2014/07/10/host-blog-on-github-using-hexo/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2014-07-09T06:23:30.000Z" class="post__time">July 9, 2014</time><h1 class="post__title"><a href="/2014/07/09/ubuntu-samba-service-setup/">Ubuntu下samba共享服务设置</a></h1></header><div class="post__main echo"><p>Samba实现了windows共享服务，配置完成后可以通过windows网上邻居交换文件。</p>
<p>首先安装samba软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> apt-get install samba
</pre></td></tr></table></figure>

<p>安装完成后，打开/etc/samba/smb.conf，配置共享目录，个人习惯配置home目录跟/web目录</p>
<figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>[homes]
   comment = Home Directories
   browseable = <span class="literal">no</span>
   <span class="comment">#允许向home目录写入文件</span>
   read only = <span class="literal">no</span>

[web]
   path = /web
   guest ok = <span class="literal">no</span>
   browseable = <span class="literal">yes</span>
   create mask = <span class="number">0644</span>
   directory mask = <span class="number">0755</span>
   read only = <span class="literal">no</span>
</pre></td></tr></table></figure>

<p>配置完成后重启samba服务，使配置文件生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> service smbd restart
</pre></td></tr></table></figure>

<p>samba有自己的用户授权体系，每个linux系统中原有的用户，都需要重新加入samba的用户库，并且重新设置密码，这样才能访问共享服务。<br>这里假设加入rose这个用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> smbpasswd <span class="operator">-a</span> rose
</pre></td></tr></table></figure>

<p>之后绑定域名dev.example.com到开发机，打开资源管理器，地址栏输入\\dev.example.com就可以访问共享的资源了。</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/samba/" class="post__tag__link">samba</a></li></ul><a href="/2014/07/09/ubuntu-samba-service-setup/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2014-07-04T06:33:30.000Z" class="post__time">July 4, 2014</time><h1 class="post__title"><a href="/2014/07/04/mercurial-repository-install-guide/">Mercurial仓库架设</a></h1></header><div class="post__main echo"><p>Mercurial是使用python编写的，因此需要安装python包管理器，常见的包管理器有easy install和pip。个人推荐使用pip，因为pip比easy install更成熟，不会出现某个python模块安装不完整，导致无法卸载也无法重新安装的问题。</p>
<p>安装easy install</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> apt-get install python-setuptools
</pre></td></tr></table></figure>

<p>用easy install安装pip </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> easy_install pip
</pre></td></tr></table></figure>

<p>在安装mercurial之前, 需要先安装gcc等编译工具，以及python的开发支持库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> apt-get install build-essential python-dev
</pre></td></tr></table></figure>

<p>安装mercurial</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> pip install mercurial
</pre></td></tr></table></figure>

<p>到目前为止mercurial已经安装完成了，命令行下输入”hg”就可以看到mercurial的help信息了。接下来配置一个mercurial的公共仓库，方便代码共享。</p>
<p>平时我的开发网站放在/web目录下面，比如域名为demo.example.com的网站，物理路径是/web/demo.example.com</p>
<p>首先初始化一个mercurial的仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>mkdir /web/demo.example.com && <span class="built_in">cd</span> /web/demo.example.com && hg init
</pre></td></tr></table></figure>

<p>接下来使用hgweb的wsgi脚本配置一个服务，详细信息可以参考: <a href="http://mercurial.selenic.com/wiki/PublishingRepositories#hgweb" target="_blank" rel="external">http://mercurial.selenic.com/wiki/PublishingRepositories#hgweb</a></p>
<p>个人喜欢gunicorn作为python app的WSGI服务器，因此先安装gunicorn</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">sudo</span> pip install gunicorn
</pre></td></tr></table></figure>

<p>/web/hgweb.py (wsgi脚本)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="comment"># An example WSGI for use with mod_wsgi, edit as necessary</span>
<span class="comment"># See http://mercurial.selenic.com/wiki/modwsgi for more information</span>

<span class="comment"># Path to repo or hgweb config to serve (see 'hg help hgweb')</span>
config = <span class="string">"/web/hgweb.config"</span>

<span class="comment"># Uncomment and adjust if Mercurial is not installed system-wide</span>
<span class="comment"># (consult "installed modules" path from 'hg debuginstall'):</span>
<span class="comment">#import sys; sys.path.insert(0, "/path/to/python/lib")</span>

<span class="comment"># Uncomment to send python tracebacks to the browser if an error occurs:</span>
<span class="keyword">import</span> cgitb; cgitb.enable()

<span class="comment"># enable demandloading to reduce startup time</span>
<span class="keyword">from</span> mercurial <span class="keyword">import</span> demandimport; demandimport.enable()

<span class="keyword">from</span> mercurial.hgweb <span class="keyword">import</span> hgweb
application = hgweb(config)
</pre></td></tr></table></figure>

<p>/web/hgweb.config 配置文件</p>
<figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>[paths]
/ = /web/*

[web]
<span class="constant">style</span> = monoblue
<span class="constant">push_ssl</span> = false
<span class="constant">allow_push</span> = *
</pre></td></tr></table></figure>

<p>绑定hgrepos.example.com到开发环境IP<br>gunicorn —workers=2 hgweb:application —bind=0.0.0.0:8001  启动guincorn服务器看看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="tag">Name</span>			<span class="tag">Description</span>		<span class="tag">Contact</span>		<span class="tag">Last</span> <span class="tag">modified</span>	 	 
<span class="tag">demo</span><span class="class">.example</span><span class="class">.com</span>	<span class="tag">unknown</span>			<span class="tag">unknown</span>		<span class="tag">Fri</span>, 04 <span class="tag">Jul</span> 2014 08<span class="pseudo">:12</span><span class="pseudo">:42</span> <span class="tag">-0400</span>
</pre></td></tr></table></figure><br>可以看到前面建立的仓库demo.example.com，成功的列出了。<br><br>下面使用apache代理gunicorn的请求，首先启用代理模块<br><br><figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>LoadModule proxy_module /usr/<span class="keyword">lib</span>/apache2/modules/mod_proxy.so
LoadModule proxy_http_module /usr/<span class="keyword">lib</span>/apache2/modules/mod_proxy_http.so
</pre></td></tr></table></figure>

<p>配置apache虚拟主机  hgrepos.example.com.conf (apache2.4需要 “Require all granted”, 详细信息见<a href="http://httpd.apache.org/docs/2.4/upgrading.html" target="_blank" rel="external">http://httpd.apache.org/docs/2.4/upgrading.html</a>)</p>
<figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="tag">&lt;VirtualHost *:80&gt;</span>
<span class="keyword"><span class="common">ServerName</span></span> hgrepos.example.com
<span class="keyword">ProxyRequests</span> <span class="literal">On</span>
<span class="tag">&lt;Proxy *&gt;</span>
<span class="keyword"><span class="common">Order</span></span> deny,allow
<span class="keyword"><span class="common">Allow</span></span> from <span class="literal">all</span>
<span class="keyword">Require</span> <span class="literal">all</span> granted
<span class="tag">&lt;/Proxy&gt;</span>
<span class="keyword">ProxyPass</span> / http://127.0.0.1:8001/
<span class="keyword">ProxyPassReverse</span> / http://127.0.0.1:8001/
<span class="tag">&lt;/VirtualHost&gt;</span>
</pre></td></tr></table></figure>

<p>如果用nginx，参考配置如下</p>
<figure class="highlight config"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre>server {
    listen          <span class="number">80</span>;
    server_name     hgrepos<span class="built_in">.</span>example<span class="built_in">.</span>com;
    server_name_in_redirect off;

    access_log  /<span class="built_in">var</span>/<span class="keyword">log</span>/nginx/hg_access<span class="built_in">.</span><span class="keyword">log</span>;
    error_log   /<span class="built_in">var</span>/<span class="keyword">log</span>/nginx/hg_error<span class="built_in">.</span><span class="keyword">log</span>;
    send_timeout     <span class="number">3</span>m;
    location <span class="subst">/</span> {
        proxy_pass http:<span class="comment">//127.0.0.1:8001;</span>
        proxy_redirect off;
        proxy_connect_timeout <span class="number">3000</span>;
        proxy_read_timeout <span class="number">3000</span>;
        proxy_send_timeout <span class="number">3000</span>;
        proxy_set_header Host <span class="variable">$host</span>;
        proxy_set_header X<span class="attribute">-Real</span><span class="attribute">-IP</span> <span class="variable">$remote_addr</span>;
        proxy_set_header X<span class="attribute">-Forwarded</span><span class="attribute">-For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;
        client_body_buffer_size <span class="number">128</span>k;
        client_max_body_size <span class="number">2000</span>m;
        proxy_buffering <span class="keyword">on</span>;
        proxy_buffer_size <span class="number">4</span>k;
        proxy_buffers <span class="number">4</span> <span class="number">32</span>k;
        proxy_busy_buffers_size <span class="number">64</span>k;
        proxy_temp_file_write_size <span class="number">64</span>k;
    }
}
</pre></td></tr></table></figure>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/mercurial/" class="post__tag__link">mercurial</a></li></ul><a href="/2014/07/04/mercurial-repository-install-guide/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2014 Yu Fang</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","yeesblog","count");
</script><script>var disqus_shortname = "yeesblog";
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script></body></html>